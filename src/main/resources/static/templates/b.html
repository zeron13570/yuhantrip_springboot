<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kakao Maps Directions API Example</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c6876a5497297dc029c4d55c6e2da7bd&libraries=services,places"></script>
    <style>
        #map {
            width: 70%;
            height: 500px;
            float: right;
        }
        .waypoint-container {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        .waypoint-container input {
            flex: 1;
        }
        .waypoint-container button {
            margin-left: 5px;
        }
        #info-container {
            width: 25%;
            float: left;
            padding: 10px;
            background-color: #f1f1f1;
            height: 500px;
            overflow-y: auto;
        }
        #info-container ul {
            list-style: none;
            padding: 0;
        }
        #info-container li {
            margin: 10px 0;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
<h1>Kakao Maps Directions API Example</h1>
<form id="directionsForm">
    <div>
        <label for="origin">출발지:</label>
        <input type="text" id="origin" name="origin" placeholder="출발지 건물 이름" required>
    </div>
    <div>
        <label for="destination">목적지:</label>
        <input type="text" id="destination" name="destination" placeholder="목적지 건물 이름" required>
    </div>
    <div id="waypoints">
        <label>경유지:</label>
        <div class="waypoint-container">
            <input type="text" class="waypoint" placeholder="경유지 건물 이름">
            <button type="button" onclick="removeWaypoint(this)">제거</button>
        </div>
    </div>
    <div>
        <button type="button" onclick="addWaypoint()">경유지 추가</button>
    </div>
    <div>
        <button type="submit">경로 찾기</button>
    </div>
</form>

<div id="map"></div>
<div id="info-container">
    <h2>도로 정보</h2>
    <ul id="road-info-list"></ul>
</div>

<div id="error-message" style="color: red;"></div>

<script>
    var mapContainer = document.getElementById('map'),
        mapOption = {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 5
        };

    var map = new kakao.maps.Map(mapContainer, mapOption);
    var places = new kakao.maps.services.Places();
    var polylines = [];
    var markers = [];

    // getCoordsByPlaceName 함수 정의
    function getCoordsByPlaceName(placeName) {
        return new Promise((resolve, reject) => {
            places.keywordSearch(placeName, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    resolve({
                        x: result[0].x,
                        y: result[0].y
                    });
                } else {
                    reject(new Error('장소를 찾을 수 없습니다: ' + placeName));
                }
            });
        });
    }

    // 폼 제출 이벤트 처리
    document.getElementById('directionsForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const origin = document.getElementById('origin').value;
        const destination = document.getElementById('destination').value;
        const waypointsElements = document.querySelectorAll('.waypoint');

        const waypointsPromises = Array.from(waypointsElements).map(element => getCoordsByPlaceName(element.value));

        // 출발지, 목적지, 경유지의 좌표 변환 후 서버로 요청
        Promise.all([getCoordsByPlaceName(origin), getCoordsByPlaceName(destination), ...waypointsPromises])
            .then(coords => {
                const originCoords = coords.shift();
                const destinationCoords = coords.shift();
                const waypointsCoords = coords.map((coord, index) => ({
                    name: `waypoint${index + 1}`,
                    x: coord.x,
                    y: coord.y
                }));

                const data = {
                    origin: originCoords,
                    destination: destinationCoords,
                    waypoints: waypointsCoords
                };

                fetch('http://localhost:8080/api/directions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            clearMap();
                            displayRoadInfo(data.route);
                            displayRouteOnMap(data.route, data.origin, data.destination, data.waypoints);
                        } else {
                            alert('경로를 찾을 수 없습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('error-message').textContent = '오류가 발생했습니다.';
                    });
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });

    function addWaypoint() {
        const waypointsDiv = document.getElementById('waypoints');
        const waypointContainer = document.createElement('div');
        waypointContainer.className = 'waypoint-container';

        const newWaypoint = document.createElement('input');
        newWaypoint.type = 'text';
        newWaypoint.className = 'waypoint';
        newWaypoint.placeholder = '경유지 건물 이름';

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = '제거';
        removeButton.onclick = function() {
            waypointsDiv.removeChild(waypointContainer);
        };

        waypointContainer.appendChild(newWaypoint);
        waypointContainer.appendChild(removeButton);
        waypointsDiv.appendChild(waypointContainer);
    }

    function removeWaypoint(button) {
        const waypointsDiv = document.getElementById('waypoints');
        waypointsDiv.removeChild(button.parentNode);
    }

    function clearMap() {
        polylines.forEach(polyline => polyline.setMap(null));
        polylines = [];
        markers.forEach(marker => marker.setMap(null));
        markers = [];
    }

    function displayRoadInfo(route) {
        const roadInfoList = document.getElementById('road-info-list');
        roadInfoList.innerHTML = '';  // 기존 도로 정보 제거

        route.sections.forEach(section => {
            section.roads.forEach(road => {
                const li = document.createElement('li');
                li.textContent = `도로 이름: ${road.name}, 거리: ${road.distance}m, 속도 제한: ${road.speed_limit}km/h`;
                roadInfoList.appendChild(li);
            });
        });
    }

    function displayRouteOnMap(route, originCoords, destinationCoords, waypointsCoords) {
        clearMap();  // 기존 마커와 선을 지웁니다.

        const markerColor = '#FF0000';  // 숫자 마커는 모두 같은 색으로 설정

        // 경유지를 포함한 전체 좌표 리스트를 만듭니다.
        const allPoints = [originCoords, ...waypointsCoords, destinationCoords];

        // 숫자 카운터를 1부터 시작
        let markerNumber = 1;

        // 각 좌표에 대해 숫자 마커를 추가합니다.
        allPoints.forEach((coords) => {
            // 마커에 숫자 표시를 위한 커스텀 오버레이 추가
            const content = `<div style="background:${markerColor};color:white;width:20px;height:20px;text-align:center;border-radius:50%;font-size:14px;">${markerNumber}</div>`;

            const overlay = new kakao.maps.CustomOverlay({
                position: new kakao.maps.LatLng(coords.y, coords.x),
                content: content,
                zIndex: 2  // 오버레이가 지도 위에 표시되도록 설정
            });

            overlay.setMap(map);  // 지도에 숫자 마커 추가
            markers.push(overlay);  // 마커 배열에 추가

            // 숫자 카운터를 증가시킵니다.
            markerNumber++;
        });

        // 마커들 사이에 선을 그립니다.
        const path = allPoints.map(coords => new kakao.maps.LatLng(coords.y, coords.x));

        const polyline = new kakao.maps.Polyline({
            path: path,  // 좌표들을 이어서 선을 만듭니다.
            strokeWeight: 3,  // 선 두께
            strokeColor: '#0000FF',  // 선 색상 (파란색)
            strokeOpacity: 0.8,  // 선 투명도
            strokeStyle: 'solid'  // 선 스타일
        });

        polyline.setMap(map);  // 지도의 선을 추가합니다.
        polylines.push(polyline);  // 폴리라인 배열에 추가

        // 전체 경로가 보이도록 지도 범위를 설정합니다.
        const bounds = new kakao.maps.LatLngBounds();
        path.forEach(point => bounds.extend(point));
        map.setBounds(bounds);
    }
</script>
</body>
</html>
